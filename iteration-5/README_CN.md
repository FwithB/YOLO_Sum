# YOLO与CVAT自动标注系统 - 迭代5

基于MCP架构的完整机器学习工作流管理系统，集成YOLO模型训练、CVAT数据标注、模型部署和自动推理功能。

## 项目概述

迭代5在迭代4的基础上实现了完整的机器学习工作流闭环，从数据上传、标注、训练、部署到推理的全流程自动化。系统现在不仅支持YOLO模型训练和浏览器自动化，还集成了完整的CVAT API、模型部署服务和数据格式转换功能。

## 系统架构

```
客户端 (main.py) <---> 服务器 (server.py)
                           |
                           +---> 训练模块 (train.py)
                           +---> 浏览器模块 (browser.py)
                           +---> CVAT API模块 (cvat_api.py)
                           +---> 部署模块 (deploy_to_cvat.py)
                           |
                           v
                    Nuclio微服务 <--> CVAT系统
```

## 主要组件

### 核心模块
- **main.py**: 客户端程序，提供11个功能选项的交互界面
- **server.py**: MCP服务器，处理客户端请求并调用相应模块
- **train.py**: YOLO模型训练模块
- **browser.py**: 浏览器自动化控制模块
- **cvat_api.py**: CVAT系统API完整封装
- **deploy_to_cvat.py**: 模型部署到Nuclio服务模块
- **config.py**: 系统配置管理

### 支持模块
- **test_model.py**: 模型测试和验证
- **deploy_templates/**: Nuclio部署模板文件
  - **function.yaml**: Nuclio函数配置模板
  - **main.py**: 推理服务代码模板

### 数据目录
- **datasets/**: 转换后的YOLO格式训练数据
- **downloads/**: 从CVAT下载的原始标注数据
- **runs/**: 模型训练输出和权重文件
- **coco128/**: 示例数据集

## 与迭代4的主要区别

| 特性 | 迭代4 | 迭代5 |
|------|-------|-------|
| 功能范围 | YOLO训练 + 浏览器自动化 | 完整ML工作流管理平台 |
| 客户端选项 | 4个基础功能 | 11个完整功能模块 |
| 核心组件 | 4个(main.py, server.py, train.py, browser.py) | 8个(增加cvat_api.py, deploy_to_cvat.py, config.py, test_model.py) |
| 数据管理 | 无数据管理能力 | 完整的数据生命周期管理 |
| 模型部署 | 无部署功能 | Nuclio微服务自动部署 |
| CVAT集成 | 基础浏览器控制 | 完整API集成和自动化 |
| 工作流集成 | 部分工作流 | 端到端闭环工作流 |
| 自然语言支持 | 基础指令解析 | 复杂工作流指令支持 |

## 客户端功能菜单详解

系统提供11个主要功能选项，每个选项的具体功能如下：

### 1. 使用自然语言指令控制系统
通过自然语言对话方式执行单个操作：
- **训练指令**: "训练yolov8n模型，使用最新数据集，训练5轮"
- **部署指令**: "部署最新训练的模型到CVAT"
- **数据指令**: "上传数据到CVAT创建新任务"
- **标注指令**: "对任务14进行自动标注"
- **下载指令**: "下载任务12的数据集"
- **转换指令**: "转换最近下载的数据集为YOLO格式"

### 2. 训练YOLO模型（手动参数）
精确控制模型训练过程：
- 选择模型类型（yolov8n/s/m/l/x）
- 设置训练轮数
- 指定数据集配置文件
- 自动发现最新转换的数据集
- 实时显示训练进度和结果

### 3. 控制浏览器（手动参数）
浏览器自动化操作：
- 打开浏览器并访问CVAT
- 自动登录CVAT系统
- 导航到指定URL
- 创建CVAT项目
- 强制重启浏览器实例
- 支持Chrome、Edge、Firefox

### 4. 部署模型到CVAT
将训练好的模型部署为推理服务：
- 自动发现最新训练的模型权重
- 生成Nuclio函数配置
- 配置GPU资源和依赖环境
- 部署为可扩展的微服务
- 与CVAT系统无缝集成

### 5. 上传数据到CVAT
创建标注任务并上传数据：
- 自动创建CVAT任务
- 上传图像数据到任务
- 配置COCO 80类标签系统
- 支持批量图像上传
- 自动压缩和格式转换

### 6. 模型推理/自动标注
使用部署的模型进行自动标注：
- 选择已部署的推理模型
- 指定要标注的CVAT任务
- 配置置信度阈值
- 设置批处理大小
- 监控标注进度和结果

### 7. 查看标注界面
打开CVAT标注界面：
- 指定任务ID和作业ID
- 自动登录CVAT系统
- 直接跳转到标注界面
- 支持多任务切换
- 浏览器状态管理

### 8. 下载数据集
从CVAT导出标注数据：
- 选择导出格式（CVAT、COCO、Datumaro等）
- 指定输出路径
- 选择是否包含图像文件
- 自动打包和下载
- 支持大数据集分批处理

### 9. 转换数据集格式
将CVAT数据转换为YOLO格式：
- 自动识别最近下载的数据集
- 解析多种标注类型（框、多边形、旋转框）
- 智能数据集划分（训练/验证）
- 生成YOLO配置文件
- 数据验证和清理

### 10. 一键下载并转换数据集
自动化的数据准备流程：
- 指定CVAT任务ID
- 自动下载标注数据
- 立即转换为YOLO格式
- 生成可用的训练配置
- 完整的操作日志记录

### 11. 退出程序
安全退出客户端程序

## 技术实现

### MCP架构扩展
- 新增`/deploy`端点处理模型部署请求
- 新增`/open_annotation`端点打开标注界面
- 扩展JSON通信协议支持复杂参数传递
- 改进错误处理和状态报告机制

### CVAT API集成
- 完整封装CVAT REST API
- 支持任务创建、数据上传、模型管理
- 实现自动标注请求和状态监控
- 数据下载和格式转换功能

### 模型部署自动化
- 基于模板的Nuclio函数生成
- 自动配置Docker镜像和依赖
- GPU资源管理和性能优化
- 服务健康检查和故障恢复

### 数据格式转换
- 支持边界框、多边形、旋转框等多种标注类型
- 智能坐标系转换和归一化
- 自动数据集验证和清理
- 生成标准YOLO配置文件

## 环境依赖

### Python依赖
```
ultralytics>=8.0.0    # YOLO模型训练
flask>=2.0.0          # HTTP服务器
requests>=2.25.0      # HTTP客户端
openai>=1.0.0         # LLM API调用
playwright>=1.30.0    # 浏览器自动化
tqdm>=4.62.0          # 进度条显示
python-dotenv>=0.19.0 # 环境变量管理
```

### 系统依赖
- Python 3.8+
- Docker（用于CVAT和Nuclio）
- WSL（Windows环境下的Linux兼容层）

### 外部服务
- CVAT标注系统（通过Docker部署）
- Nuclio无服务器计算平台
- OpenRouter API（用于自然语言处理）

## 安装配置

### 1. 克隆项目
```bash
git clone <repository-url>
cd yolo-cvat-automation
```

### 2. 安装Python依赖
```bash
pip install -r requirements.txt
python -m playwright install
```

### 3. 配置CVAT环境
```bash
# 下载并启动CVAT
git clone https://github.com/opencv/cvat.git
cd cvat
docker-compose up -d
```

### 4. 配置API密钥
在`main.py`中设置API密钥或通过环境变量：
```bash
export OPENROUTER_API_KEY=your_api_key_here
```

### 5. 配置CVAT连接
编辑`config.py`文件，设置CVAT连接参数：
```python
CVAT_URL = "http://localhost:8080"
CVAT_USERNAME = "admin"
CVAT_PASSWORD = "your_password"
```

## 使用指南

### 快速开始

1. **启动服务器**
```bash
python server.py
```

2. **运行客户端**
```bash
python main.py
```

3. **选择操作模式**
   - 对于新用户，推荐使用自然语言指令模式
   - 对于精确控制，使用手动参数模式

### 典型工作流示例

#### 场景1：训练自定义模型
```
1. 上传数据到CVAT → 选择菜单项5
2. 在CVAT中进行人工标注
3. 下载并转换数据集 → 选择菜单项10
4. 训练YOLO模型 → 选择菜单项2
5. 部署模型到CVAT → 选择菜单项4
```

#### 场景2：使用预训练模型标注
```
1. 上传待标注数据 → 选择菜单项5
2. 运行自动标注 → 选择菜单项6
3. 查看标注结果 → 选择菜单项7
4. 下载标注数据 → 选择菜单项8
```

#### 场景3：自然语言控制
```
输入："下载任务14的数据集"
系统执行：自动从CVAT下载指定任务的标注数据

输入："转换最近下载的数据集"
系统执行：将下载的CVAT数据转换为YOLO训练格式

输入："训练yolov8n模型使用最新数据集"
系统执行：使用转换后的数据集训练指定模型
```

### 高级功能

#### 自定义模型部署
系统会自动发现最新训练的模型权重，并生成对应的Nuclio服务：
- 自动配置GPU资源
- 生成唯一的服务名称
- 集成COCO 80类标签系统

#### 数据集管理
- 自动识别和推荐最新转换的数据集
- 支持多种数据格式的智能转换
- 数据集版本管理和历史记录

#### 批量操作
- 支持多任务并行处理
- 批量数据下载和转换
- 自动重试和错误恢复

## 故障排除

### 常见问题

**1. CVAT连接失败**
- 检查Docker服务是否正常运行
- 验证CVAT容器状态：`docker ps`
- 确认端口8080未被占用

**2. 浏览器自动化失败**
- 尝试使用不同的浏览器类型
- 检查Playwright浏览器驱动是否安装完整
- 确保系统有图形界面环境

**3. 模型部署失败**
- 检查Nuclio服务是否正常运行
- 验证模型文件路径和权限
- 查看部署日志获取详细错误信息

**4. 自然语言解析错误**
- 验证OpenRouter API密钥配置
- 检查网络连接状态
- 使用手动参数模式作为备选方案

### 日志文件
系统会生成详细的日志文件：
- `mcp_client.log` - 客户端操作日志
- `mcp_server.log` - 服务器运行日志
- `browser_controller.log` - 浏览器操作日志

### 调试模式
在开发环境中，可以启用调试模式获取更详细的信息：
```python
logging.basicConfig(level=logging.DEBUG)
```

## 性能优化

### 硬件建议
- **CPU**: 8核心以上，支持多任务并行处理
- **内存**: 16GB以上，用于大型数据集处理
- **GPU**: NVIDIA显卡，支持CUDA加速训练和推理
- **存储**: SSD硬盘，提高数据IO性能

### 系统调优
- 调整批处理大小以优化GPU利用率
- 配置合适的工作进程数量
- 使用数据缓存减少重复IO操作

## 扩展开发

### 添加新的数据格式
在`cvat_api.py`中扩展`FORMAT_MAP`字典：
```python
FORMAT_MAP["CUSTOM_FORMAT"] = "Custom Format 1.0"
```

### 集成新的模型架构
修改`train.py`和部署模板以支持其他深度学习框架。

### 自定义标注类型
扩展转换功能以支持点标注、线段标注等其他标注类型。

## 许可证

本项目采用MIT许可证。详见LICENSE文件。

## 贡献指南

欢迎通过以下方式贡献：
- 提交Issue报告问题
- 提交Pull Request改进代码
- 完善文档和使用示例
- 分享使用经验和最佳实践